<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student</title>
    <!--script type="module" src="./script.js"></script-->
  </head>
  <body>
    <h1>Student</h1>

    <label for="connID">
      Enter Connection ID:
      <input type="number" name="connID" id="connID" placeholder="1234567890" inputmode="latin" size="15" maxlength="10"/>
    </label>

    <button id="connectButton" name="connectButton" class="buttonleft">Connect</button>
    <button id="disconnectButton"name="disconnectButton" class="buttonright" disabled>Disconnect</button>

    <div class="messagebox">
      <label for="message">
        Enter a message:
        <input type="text" name="message" id="message" placeholder="Message text" inputmode="latin" size="60" maxlength="120" disabled />
      </label>
      <button id="sendButton" name="sendButton" class="buttonright" disabled>Send</button>
    </div>

    <div class="messagebox" id="receive-box">
      <h2>Messages:</h2>
    </div>

    <script type="module">
      import {ClientPeerConnection} from './script.js';
      let connectButton = null;
      let disconnectButton = null;
      let sendButton = null;
      let messageInputBox = null;
      let receiveBox = null;

      let connectId = null;

      let peerConnection = null;



      function startup() {
        connectButton = document.getElementById("connectButton");
        disconnectButton = document.getElementById("disconnectButton");
        sendButton = document.getElementById("sendButton");
        messageInputBox = document.getElementById("message");
        receiveBox = document.getElementById("receive-box");
        connectId = document.getElementById("connID");

        // Set event listeners for user interface widgets

        connectButton.addEventListener("click", connectPeers, false);
        disconnectButton.addEventListener("click", disconnectPeers, false);
        sendButton.addEventListener("click", sendMessage, false);
      }

      async function connectPeers(){
        if (connectId.value.trim() != ""){
          peerConnection = new ClientPeerConnection(connectId.value.trim(), handleReceiveMessage, connected, disconnected);
          await peerConnection.connect();
        }
      }

      function connected(){
        messageInputBox.disabled = false;
        messageInputBox.focus();
        sendButton.disabled = false;
        disconnectButton.disabled = false;
        connectButton.disabled = true;
      }
      function disconnected(){
        messageInputBox.disabled = true;
        sendButton.disabled = true;
        connectButton.disabled = false;
        disconnectButton.disabled = true;
      }

      function handleReceiveMessage(data){
        const newDiv = document.createElement("div");
        const line = document.createElement("p");
        const lineLabel = document.createElement("strong");
        lineLabel.innerHTML = "Received: ";
        line.innerHTML = data.data;
        line.style = "display: inline"
        newDiv.appendChild(lineLabel);
        newDiv.appendChild(line);
        receiveBox.appendChild(newDiv);
      }

      function sendMessage() {
        const message = messageInputBox.value;

        peerConnection.commandChannel.send(message);

        const newDiv = document.createElement("div");
        const line = document.createElement("p");
        const lineLabel = document.createElement("strong");
        lineLabel.innerHTML = "Sent: ";
        line.innerHTML = message;
        line.style = "display: inline"
        newDiv.appendChild(lineLabel);
        newDiv.appendChild(line);
        receiveBox.appendChild(newDiv);


        messageInputBox.value = "";
        messageInputBox.focus();
      }

      async function disconnectPeers(){
        peerConnection.disconnect();
      }


      startup();
    </script>
  </body>
</html>
